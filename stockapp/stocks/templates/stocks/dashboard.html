<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Stock Trader</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Stock List</h5>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div class="list-group">
                            {% for stock in stocks %}
                                <a href="#" class="list-group-item list-group-item-action stock-item" data-symbol="{{ stock.symbol }}">
                                    <strong>{{ stock.symbol }}</strong>
                                    <br>
                                    <small class="text-muted">{{ stock.categories|join:", " }}</small>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 id="chart-title">Select a stock to view chart</h5>
                    </div>
                    <div class="card-body">
                        <div id="stockChart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stockChart = null;

        document.querySelectorAll('.stock-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const symbol = this.getAttribute('data-symbol');
                loadStockChart(symbol);
            });
        });

        function loadStockChart(symbol) {
            document.getElementById('chart-title').textContent = `${symbol} - 1 Month Daily Candlestick Chart`;

            fetch(`/api/stock-chart/${symbol}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading chart: ' + data.error);
                        return;
                    }

                    const trace = {
                        x: data.data.map(d => d.x),
                        open: data.data.map(d => d.open),
                        high: data.data.map(d => d.high),
                        low: data.data.map(d => d.low),
                        close: data.data.map(d => d.close),
                        type: 'candlestick',
                        name: symbol,
                        increasing: {line: {color: 'green'}},
                        decreasing: {line: {color: 'red'}}
                    };

                    const layout = {
                        title: `${symbol} - 1 Month Daily Chart`,
                        xaxis: {
                            title: 'Date',
                            type: 'category'
                        },
                        yaxis: {
                            title: 'Price',
                            autorange: true
                        },
                        margin: {
                            l: 50,
                            r: 50,
                            t: 50,
                            b: 50
                        }
                    };

                    Plotly.newPlot('stockChart', [trace], layout);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading chart data');
                });
        }
    </script>
</body>
</html>